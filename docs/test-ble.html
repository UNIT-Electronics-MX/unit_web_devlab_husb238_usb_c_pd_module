<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HUSB238 - Test BLE R√°pido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status { 
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
    #log {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 5px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîå HUSB238 BLE Test</h1>
    
    <div id="status" class="status disconnected">
      ‚ùå DESCONECTADO
    </div>

    <div style="margin: 20px 0;">
      <button id="connect-btn">üîó Conectar</button>
      <button id="disconnect-btn" disabled>üîå Desconectar</button>
    </div>

    <h3>Comandos de Prueba:</h3>
    <button onclick="send('*IDN?')">üÜî Identificaci√≥n</button>
    <button onclick="send('STAT?')">üìä Estado</button>
    <button onclick="send('PD:LIST?')">üìã Listar Voltajes</button>
    <button onclick="send('PD:GET?')">‚ö° Voltaje Actual</button>
    <button onclick="send('CURR:GET?')">üîã Corriente Actual</button>
    <br>
    <button onclick="send('PD:SET5')">5V</button>
    <button onclick="send('PD:SET9')">9V</button>
    <button onclick="send('PD:SET12')">12V</button>
    <button onclick="send('PD:SET15')">15V</button>
    <button onclick="send('PD:SET20')">20V</button>

    <div id="log"></div>
  </div>

  <script>
    const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
    const COMMAND_CHAR_UUID = '6d68efe5-04b6-4a85-abc4-c2670b7bf7fd';
    const RESPONSE_CHAR_UUID = 'f27b53ad-c63d-49a0-8c0f-9f297e6cc520';

    let device = null;
    let commandChar = null;
    let responseChar = null;
    let buffer = '';

    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');

    function log(msg, color = '#0f0') {
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function connect() {
      try {
        log('üîç Buscando HUSB238...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ 
            name: 'HUSB238',
            services: [SERVICE_UUID]
          }]
        });

        log('‚úÖ Dispositivo encontrado: ' + device.name);
        const server = await device.gatt.connect();
        log('üîó Conectado al GATT');
        
        const service = await server.getPrimaryService(SERVICE_UUID);
        log('üì° Servicio obtenido');
        
        commandChar = await service.getCharacteristic(COMMAND_CHAR_UUID);
        responseChar = await service.getCharacteristic(RESPONSE_CHAR_UUID);
        log('‚úÖ Caracter√≠sticas obtenidas');
        
        await responseChar.startNotifications();
        responseChar.addEventListener('characteristicvaluechanged', handleResponse);
        log('üîî Notificaciones habilitadas');
        
        device.addEventListener('gattserverdisconnected', onDisconnect);
        
        statusDiv.className = 'status connected';
        statusDiv.textContent = '‚úÖ CONECTADO';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        
        log('üéâ ¬°Conexi√≥n establecida!', '#0ff');
        
        // Auto identificaci√≥n
        setTimeout(() => send('*IDN?'), 500);
        
      } catch(error) {
        log('‚ùå Error: ' + error, '#f00');
      }
    }

    function handleResponse(event) {
      const decoder = new TextDecoder('utf-8');
      const chunk = decoder.decode(event.target.value);
      buffer += chunk;
      
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      
      lines.forEach(line => {
        if (line.trim()) {
          log('üì• ' + line.trim(), '#ff0');
        }
      });
    }

    async function send(cmd) {
      if (!commandChar) {
        log('‚ùå No conectado', '#f00');
        return;
      }
      
      try {
        log('üì§ ' + cmd, '#0ff');
        const encoder = new TextEncoder();
        await commandChar.writeValue(encoder.encode(cmd + '\n'));
      } catch(error) {
        log('‚ùå Error enviando: ' + error, '#f00');
      }
    }

    function onDisconnect() {
      log('‚ö†Ô∏è Desconectado', '#fa0');
      statusDiv.className = 'status disconnected';
      statusDiv.textContent = '‚ùå DESCONECTADO';
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      commandChar = null;
      responseChar = null;
    }

    function disconnect() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
        log('üîå Desconectado manualmente');
      }
    }

    connectBtn.onclick = connect;
    disconnectBtn.onclick = disconnect;

    // Verificar soporte
    if (!navigator.bluetooth) {
      log('‚ùå Web Bluetooth no soportado en este navegador', '#f00');
      log('‚ÑπÔ∏è Usa Chrome, Edge u Opera', '#fa0');
      connectBtn.disabled = true;
    } else {
      log('‚úÖ Web Bluetooth disponible', '#0f0');
      log('‚ÑπÔ∏è Haz clic en "Conectar" para empezar', '#0ff');
    }
  </script>
</body>
</html>
